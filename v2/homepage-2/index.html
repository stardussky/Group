<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      #threeJs {
        height: 100vh;
      }

      #threeJs button {
        border: none;
        outline: none;
        background-color: transparent;
        cursor: pointer;
      }

      #stats {
        position: absolute;
        left: 0;
        top: 0;
      }

      #projectManagement {
        position: relative;
        /* animation: btn 6s infinite; */
      }

      @keyframes btn {
        0% {
          top: 10px;
          opacity: 0.8;
        }

        90% {
          top: 0;
          opacity: 0.8;
        }

        100% {
          top: 0;
          opacity: 0;
        }
      }
    </style>
  </head>

  <body>
    <div id="stats"></div>
    <div id="threeJs">
      <button id="projectManagement">Night</button>
      <button id="clock">Day</button>
      <button id="rain">Rain</button>
    </div>

    <script src="./libs/three.min.js"></script>
    <script src="./libs/OrbitControls.js"></script>
    <script src="./libs/OBJLoader.js"></script>
    <script src="./libs/MTLLoader.js"></script>
    <script src="./libs/TweenMax.min.js"></script>
    <script src="./libs/TimelineMax.min.js"></script>
    <script src="./libs/CSS2DRenderer.js"></script>
    <script src="./js/object.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r16/Stats.min.js"></script>
    <script type="x-shader/x-fragment" id="fragmentshader">
      uniform vec3 color;
        uniform sampler2D texture;
        varying float opacity;
        varying vec3 vColor;
        void main() {
            gl_FragColor = vec4(vColor * color, 1);
            gl_FragColor = gl_FragColor * texture2D( texture, gl_PointCoord );
        }
    </script>
    <script type="module">
      import { Particle, RainDrop } from "./js/particleSystem.js";

      let scene, renderer, CSS2DRenderer, camera, width, height, aspect, skyBox;
      const threeJs = document.getElementById("threeJs");
      scene = new THREE.Scene();
      renderer = new THREE.WebGLRenderer({
        antialias: true
      });
      renderer.setSize(width, height);
      renderer.setClearColor(0x000000, 1);
      // renderer.shadowMap.enabled = true;
      CSS2DRenderer = new THREE.CSS2DRenderer();
      CSS2DRenderer.setSize(width, height);
      CSS2DRenderer.domElement.style.position = "absolute";
      CSS2DRenderer.domElement.style.top = 0;
      CSS2DRenderer.domElement.style.outline = "none";
      threeJs.appendChild(CSS2DRenderer.domElement);
      threeJs.appendChild(renderer.domElement);

      camera = new THREE.PerspectiveCamera(45, aspect, 1, 5000);
      camera.position.set(0, 250, 800);
      const cameraControl = new THREE.OrbitControls(
        camera,
        CSS2DRenderer.domElement
      );
      cameraControl.enableDamping = true;
      cameraControl.dampingFactor = 0.01;
      cameraControl.autoRotate = true;
      cameraControl.minDistance = 250;
      cameraControl.maxDistance = 600;
      // scene.fog = new THREE.FogExp2(0xffffff, 0.00015)

      function handleWindowResize() {
        width = innerWidth;
        height = innerHeight;
        renderer.setSize(width, height);
        CSS2DRenderer.setSize(width, height);
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
      }
      window.addEventListener("resize", handleWindowResize);

      const globalLight = new THREE.AmbientLight(0xffffff, 0.8);
      // const directionalLight = new THREE.DirectionalLight(0xffeedd);
      // directionalLight.position.set(0, 0, 1);
      // const insideLight = new THREE.HemisphereLight(0xffffff, 0xffffff, .25);
      const shadowLight = new THREE.DirectionalLight(0xffffff, 0.2);
      // insideLight.position.set(-30, 40, 0);
      shadowLight.position.set(500, 400, 0);
      scene.add(globalLight, shadowLight);
      // shadowLight.castShadow = true;
      // var spotLightHelper = new THREE.DirectionalLightHelper(shadowLight);
      // scene.add(spotLightHelper);
      var axesHelper = new THREE.AxesHelper(5);
      scene.add(axesHelper);

      let textureLoader = new THREE.TextureLoader();

      const dayTimeTextures = [
        "mat_ft.png",
        "mat_bk.png",
        "mat_up.png",
        "mat_dn.png",
        "mat_rt.png",
        "mat_lf.png"
      ];
      const nightTimeTextures = [
        "mat_ft_n.png",
        "mat_bk_n.png",
        "mat_up_n.png",
        "mat_dn_n.png",
        "mat_rt_n.png",
        "mat_lf_n.png"
      ];
      function createSkyBox(texture) {
        const boxTexture = texture.reduce((prev, mat) => {
          let texture = new THREE.MeshBasicMaterial({
            map: textureLoader.load(`./skybox/${mat}`)
          });
          texture.side = THREE.BackSide;
          prev.push(texture);
          return prev;
        }, []);
        const skyBoxGeo = new THREE.BoxGeometry(2500, 2500, 2500);
        skyBox = new THREE.Mesh(skyBoxGeo, boxTexture);
        scene.add(skyBox);
      }
      createSkyBox(dayTimeTextures);

      /////////////////////////////////////////////////////////////
      new THREE.MTLLoader().load(`./low-poly-mill.mtl`, mtl => {
        mtl.preload();
        new THREE.OBJLoader()
          .setMaterials(mtl)
          .load(`./low-poly-mill.obj`, obj => {
            obj.position.set(0, -150, 0);
            obj.rotation.y = Math.PI * -0.8;
            obj.scale.set(1.3, 1.3, 1.3);
            scene.add(obj);
          });
      });
      /////////////////////////////////////////////////////////////

      let particle = new Particle(3, 0.8, 0.3, 0.3),
        rain;
      scene.add(particle.particleSystem);

      let button1 = new CircleButton(50, 30, 50, "projectManagement");
      scene.add(button1.button);
      scene.add(button1.fontLabel);
      button1.update();
      let button2 = new CircleButton(-50, 30, -50, "clock");
      scene.add(button2.button);
      scene.add(button2.fontLabel);
      button2.update();
      let button3 = new CircleButton(0, 60, 0, "rain");
      scene.add(button3.button);
      scene.add(button3.fontLabel);
      button3.update();

      //test
      let a;
      threeJs.addEventListener("mousemove", function(e) {
        let mouse = new THREE.Vector2();
        let raycaster = new THREE.Raycaster();
        let obj;

        mouse.x = (e.clientX / renderer.domElement.clientWidth) * 2 - 1;
        mouse.y = -(e.clientY / renderer.domElement.clientHeight) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        let intersects = raycaster.intersectObjects(scene.children, true);
        if (intersects.length > 0) {
          obj = intersects[0].object;
          if (obj.parent.type !== "Scene") {
            while (obj.parent.type !== "Scene") {
              obj = obj.parent;
            }
          }
        }

        if (obj.name === "button") {
          document.documentElement.style.cursor = "pointer";
          let timeline = new TimelineMax();
          timeline.to(obj.scale, 1, { x: 2, y: 2, z: 2 });
          a = obj;
        } else {
          document.documentElement.style.cursor = "auto";
          if (a) {
            let timeline = new TimelineMax();
            timeline.to(a.scale, 1, { x: 1, y: 1, z: 1 });
          }
        }
        // console.log(obj)
      });
      let btn = document.getElementById("projectManagement");
      btn.addEventListener("click", () => {
        if (rain) scene.remove(rain.rain, rain.flashLight);
        scene.remove(particle.particleSystem);
        scene.remove(skyBox);
        rain = "";
        particle = new Particle(3, 0.3, 0.8, 0.8);
        scene.add(particle.particleSystem);
        createSkyBox(nightTimeTextures);
      });
      let btn2 = document.getElementById("clock");
      btn2.addEventListener("click", () => {
        if (rain) scene.remove(rain.rain, rain.flashLight);
        scene.remove(particle.particleSystem, rain.rain);
        scene.remove(skyBox);
        rain = "";
        particle = new Particle(3, 0.8, 0.3, 0.3);
        scene.add(particle.particleSystem);
        createSkyBox(dayTimeTextures);
      });
      let btn3 = document.getElementById("rain");
      btn3.addEventListener("click", () => {
        scene.remove(particle.particleSystem);
        scene.remove(skyBox);
        particle = "";
        rain = new RainDrop();
        scene.add(rain.rain, rain.flashLight);
        createSkyBox(nightTimeTextures);
      });

      function initStats() {
        let stats = new Stats();
        stats.setMode(0);
        document.getElementById("stats").append(stats.domElement);
        return stats;
      }
      let statsUI = initStats();

      function render() {
        particle ? particle.update() : rain.update();

        cameraControl.update();
        statsUI.update();
        requestAnimationFrame(render);
        renderer.render(scene, camera);
        CSS2DRenderer.render(scene, camera);
      }
      handleWindowResize();
      render();
    </script>
  </body>
</html>
