<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <style>
    * {
      margin: 0;
      padding: 0;
    }
    #threeJs {
      height: 100vh;
    }
    #stats {
      position: absolute;
      left: 0;
      top: 0;
    }
  </style>
</head>
<body>
  <div id="stats"></div>
  <div id="threeJs"></div>
  <script src="./libs/three.min.js"></script>
  <script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r16/Stats.min.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js'></script>
  <script src="./libs/CannonDebugRenderer.js"></script>
  <script src="./js/model.js"></script>
  <script>
    //cannon
    const timeStep = 1.0 / 60.0;
    const world = new CANNON.World();
    world.gravity.set(0, -200, 0);
    world.broadphase = new CANNON.NaiveBroadphase();
    //three
    let scene, renderer, camera, width, height, aspect;
    const threeJs = document.getElementById('threeJs');
    const whiteMat = new THREE.MeshLambertMaterial({color: 0xF4F5F5});
    const blackMat = new THREE.MeshLambertMaterial({color: 0x434343});
    // const pinkMat = new THREE.MeshLambertMaterial({color: 0xeda5ba});
    const brownMat = new THREE.MeshLambertMaterial({color: 0xC4AD83});
    const deepBrownMat = new THREE.MeshLambertMaterial({color: 0x8C7051});
    const grayMat = new THREE.MeshLambertMaterial({color: 0x576066});
    // const blueMat = new THREE.MeshLambertMaterial({color: 0x2A3D45});
    const greenMat = new THREE.MeshLambertMaterial({color: 0x84DD63});
    const deepGreenMat = new THREE.MeshLambertMaterial({color: 0x214F4B});
    const silverMat = new THREE.MeshPhysicalMaterial({color: 0x999999});
    const glassMat = new THREE.MeshPhongMaterial({color: 0xF4F5F5});
    glassMat.transparent = true;
    glassMat.opacity = .2;
    let texture1 = new THREE.TextureLoader().load("./woodMat04.jpg");
    // texture1.wrapS = texture1.wrapT = THREE.RepeatWrapping;
    // texture1.repeat.set(1, 3);
    let woodMat1 = new THREE.MeshLambertMaterial({ map: texture1 });
    let texture2 = new THREE.TextureLoader().load("./woodMat02.svg");
    let woodMat2 = new THREE.MeshLambertMaterial({ map: texture2 });
    let texture3 = new THREE.TextureLoader().load("./wallMat.jpg");
    texture3.wrapS = texture3.wrapT = THREE.RepeatWrapping;
    texture3.repeat.set(3, 2);
    let wallMat = new THREE.MeshLambertMaterial({ map: texture3 });
    let texture4 = new THREE.TextureLoader().load("./woodMat03.jpg");
    let woodMat3 = new THREE.MeshLambertMaterial({ map: texture4 });
    const floorCM = new CANNON.Material();
    const objCM = new CANNON.Material();

    scene = new THREE.Scene();
    renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setSize(width, height);
    renderer.setClearColor(0x87CEEB, 1);
    renderer.shadowMap.enabled = true;
    threeJs.appendChild(renderer.domElement);
    camera = new THREE.PerspectiveCamera(50, aspect, 1, 1000);
    camera.position.set(0, 80, 90);
    camera.lookAt(new THREE.Vector3(0, 60, 0));
    cameraControl = new THREE.OrbitControls(camera, renderer.domElement);

    function handleWindowResize() {
      width = innerWidth;
      height = innerHeight;
      renderer.setSize(width, height);
      camera.aspect = width / height;
      camera.updateProjectionMatrix();
    }
    window.addEventListener('resize', handleWindowResize);

    const globalLight = new THREE.HemisphereLight(0xffffff, 0xffffff, 1);
    const shadowLight = new THREE.SpotLight(0xffffff, .1);
    const leftLight = new THREE.DirectionalLight(0xffffff, .2);
    leftLight.position.set(-80, 20, 0);
    shadowLight.position.set(-50, 40, 40);
    shadowLight.castShadow = true;
    // shadowLight.shadowMapWidth = shadowLight.shadowMapHeight = 768;
    scene.add(globalLight, shadowLight, leftLight);

    var shadowLightHelper = new THREE.SpotLightHelper(shadowLight, 5 );
    var leftLightHelper = new THREE.DirectionalLightHelper(leftLight, 5 );
    // scene.add(shadowLightHelper,leftLightHelper );
    
    //model
    const floor = new Floor(120, 100); 
    scene.add(floor.floor);
    world.add(floor.floorBody);
    const wallWindow1 = new WallWindow(10, 20, .5, -60, 45);
    const wallWindow2 = new WallWindow(10, 20, .5, -60, 35.5);
    const wallWindow3 = new WallWindow(10, 20, .5, -60, 26);
    const wallWindow4 = new WallWindow(10, 20, .5, -60, 16.5);
    const wallWindow5 = new WallWindow(70, 20, 0, -25, -50);
    const wallWindow6 = new WallWindow(20, 20, .5, 60, -25);
    const wallWindow7 = new WallWindow(50, 20, 0, 35, 2.5);
    const wallWindow8 = new WallWindow(30, 20, .5, -5, 35);
    scene.add(
      wallWindow1.wallWindow, 
      wallWindow2.wallWindow, 
      wallWindow3.wallWindow, 
      wallWindow4.wallWindow,
      wallWindow5.wallWindow,
      wallWindow6.wallWindow,
      wallWindow7.wallWindow,
      wallWindow8.wallWindow
    );
    world.add(wallWindow1.windowBody);
    const wall1 = new Wall(62.5, -.5, -60, -18.5);
    const wall2 = new Wall(50, 0, 35, -50);
    const wall3 = new Wall(15, -.5, 60, -42.5);
    const wall4 = new Wall(65, -.5, 60, 17.5);
    const wall5 = new Wall(5, -.5, 10, 2.5, 5);
    const wall6 = new Wall(30, -.5, 35, 35);
    scene.add(wall1.wall, wall2.wall, wall3.wall, wall4.wall, wall5.wall, wall6.wall);
    world.add(wall1.wallBody);
    const floorWindow1 = new FloorWindow(10, 20, .5, 10, -45);
    const floorWindow2 = new FloorWindow(10, 20, .5, 10, -35);
    const floorWindow3 = new FloorWindow(10, 20, .5, 10, -15);
    const floorWindow4 = new FloorWindow(10, 20, .5, 10, -5);
    scene.add(
      floorWindow1.floorWindow,
      floorWindow2.floorWindow,
      floorWindow3.floorWindow,
      floorWindow4.floorWindow,
    );
    world.add(floorWindow1.windowBody);
    const door = new Door(8, 17, .3, 12.5, -33);
    scene.add(door.door);
    world.add(door.doorBody);
    const officeDesk1 = new OfficeDesk(25, 10, 10, -1, -30, -30);
    const officeDesk2 = new OfficeDesk(20, 12.5, 10, -.5, -36.25, -15);
    const officeDesk3 = new OfficeDesk(20, 12.5, 10, .5, -23.75, -15);
    scene.add(officeDesk1.desk, officeDesk2.desk, officeDesk3.desk);
    world.add(officeDesk1.deskBody);
    const teaDesk1 = new TeaDesk(8, 8, -45, 35);
    const teaDesk2 = new TeaDesk(8, 8, -20, 35);
    scene.add(teaDesk1.desk, teaDesk2.desk);
    world.add(teaDesk1.deskBody);
    const meetingDesk1 = new MeetingDesk(15, 10, 30, 0, 40, -20, woodMat2);
    const meetingDesk2 = new MeetingDesk(10, 8, 30, .5, 15, 35, woodMat3);
    scene.add(meetingDesk1.desk, meetingDesk2.desk);
    world.add(meetingDesk1.deskBody)
    const plant1 = new Plant(5, 55, 7, greenMat);
    const plant2 = new Plant(10, -55, -45, deepGreenMat, 3.5);
    scene.add(plant1.plant, plant2.plant);
    world.add(plant1.plantBody);
    const bookcase = new Bookcase(20, 20, 0, 30, -48.5);
    scene.add(bookcase.bookcase);
    world.add(bookcase.bookcaseBody);
    const forcer = new Forcer(15, 8, -.5, 56, 35);
    scene.add(forcer.forcer);
    world.add(forcer.forcerBody);
    const photo1 = new Photo(10, 10, 0, 50, 15, -49, './photo_01.png');
    const photo2 = new Photo(15, 10, -.5, 34, 15, 35, './photo_02.png');
    scene.add(photo1.photo, photo2.photo);
    world.add(photo1.photoBody);

    //debug
    let cannonDebugRenderer = new THREE.CannonDebugRenderer(scene, world)
    function initStats() {
      let stats = new Stats();
      stats.setMode(0);
      document.getElementById('stats').append(stats.domElement);
      return stats;
    }
    let statsUI = initStats();

    function render(){
      world.step(timeStep);

      requestAnimationFrame(render);
      cameraControl.update();
      renderer.render(scene, camera);
      
      statsUI.update();
      cannonDebugRenderer.update() // Update the debug renderer
    }
    handleWindowResize();
    render();
  </script>
</body>
</html>